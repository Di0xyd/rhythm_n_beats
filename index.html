<!DOCTYPE html>
<html>
<head>

	<!-- Latest compiled and minified Bootstrap CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">


	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

	<title>IoT - Rythm'n Hits</title>

	<style type="text/css">
		body {
		  padding-top: 50px;
		}
		.content {
		  padding: 40px 15px;
		  text-align: center;
		}

	</style>

</head>
<body>
	<nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Rythm'n Hits</a>
        </div>
      </div>
    </nav>
	<div class="container">
		<div class="content">
			<h1>IoT Project - Rythm'n Hits</h1>
			<div class="row">
				<div class="col-md-6">
					<br><br>
					<h3 class="actual">Good beats  : <span id="goodBeats"></span></h3>
					<h3 class="actual">Bad beats : <span id="badBeats"></span></h3>
					<br><br>
					<h3 class="actual">Current BPM: <span id="actualBPM"></span></h3>
					<form method="get" action="" id="updateBPMForm" class="form-inline">
						<input type="number" id="inputBpm" class="form-control mb-2 mr-sm-2 mb-sm-0" name="bpm">
						<input type="submit" class="btn btn-primary" value="Update BPM">
					</form>
					<br><br>
					<h3 class="actual">Current Time definition : <span id="actualTD"></span></h3>
					<form method="get" action="" id="updateTDForm" class="form-inline">
						<input type="number" id="inputTD" class="form-control mb-2 mr-sm-2 mb-sm-0" name="timedefinition">
						<input type="submit" class="btn btn-primary" value="Update Time definition">
					</form>
				</div>
				<div class="col-md-6">
					<div class="ct-chart ct-perfect-fourth"></div>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


	<script>
		$(document).ready(function() {

			getCurrentBPM();
			getTimeDefinition();

			getGoodBeats();
			getBadBeats();
			getBeatsData();

			setInterval(getGoodBeats, 5000);
			setInterval(getBadBeats, 5000);
			setInterval(getBeatsData, 500);

			$('#updateBPMForm').submit(function(form) {
				form.preventDefault();
				$.ajax({
					url: 'http://10.33.3.114/setbpm',
					type: 'get',
					data: $("#updateBPMForm").serialize(),
					success: function() {
						getCurrentBPM();
					}
				});
			});
		});

		$('#updateTDForm').submit(function(form) {
			form.preventDefault();
			$.ajax({
				url: 'http://10.33.3.114/settimedefinition',
				type: 'get',
				data: $("#updateTDForm").serialize(),
				success: function() {
					getTimeDefinition();
				}
			});
		});

		function getCurrentBPM() {
			$.get("http://10.33.3.114/getbpm", function (data) {
				$("#actualBPM").html(data);
				$("#inputBpm").val(data);
			});
		}

		function getTimeDefinition() {
			$.get("http://10.33.3.114/gettimedefinition", function (data) {
				$("#actualTD").html(data);
				$("#inputTD").val(data);
			});
		}

		function getGoodBeats() {
			$.get("http://10.33.3.114/getgoodbeats", function (data) {
				$("#goodBeats").html(data);
			});
		}

		function getBadBeats() {
			$.get("http://10.33.3.114/getbadbeats", function (data) {
				$("#badBeats").html(data);
			});
		}

		var label = [];
		var beats = [];
		var bad = [];
		startIndex = 0;

		function getBeatsData() {
			$.get("http://10.33.3.114/getbeatsdata", function (data) {
				var beatsData = $.csv.toArrays(data);

				$.each(beatsData, function(index, row) {

					if(label.length == 0 ||Â label[label.length - 1] < row[0]){
						label.push(row[0]);

						if(row[1] == 1)
							beats.push(row[1] + 10);
						else
							beats.push(5);
					}
					startIndex = label.length - 10;
					if(startIndex < 0){
						startIndex = 0;
					}

				});

				new Chartist.Bar('.ct-chart', {
					labels: label.slice(startIndex, label.length),
					series: [
						beats.slice(startIndex, label.length)
					]
				}, {
					seriesBarDistance: 10,
					reverseData: false,
					horizontalBars: false,
					axisY: {
						offset: 10,
						type: Chartist.FixedScaleAxis
					}
				});
			});
		}
	</script>
</body>
</html>
